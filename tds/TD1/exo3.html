<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TD1 – Exercice 3 : Leaflet Plus</title>
  <link rel="stylesheet" href="../../css/styles.css" />
  <script defer src="../../js/script.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    .wrap{width:min(1100px,95vw);margin:20px auto}
    #map{height:72vh;border-radius:12px;border:1px solid var(--border)}
    .back{display:inline-block;margin:14px 0}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0}
    .muted{color:var(--muted)}
    .info-box{padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:10px}
    .legend{background:rgba(20,20,20,.92);color:#fff;border:2px solid #333;border-radius:12px;padding:13px 15px;line-height:1.45;min-width:230px;font-size:15px;box-shadow:0 3px 16px rgba(0,0,0,.25)}
    .legend h4{margin:0 0 8px 0;font-size:16px;font-weight:700}
    .sym{display:flex;align-items:center;gap:8px;margin:8px 0}
    .chip{width:20px;height:20px;border-radius:50%;display:inline-block;border:2px solid #fff}
    .chip-blue{background:#0a39ff}
    .chip-cyan{background:#21f7ef;border-color:#0abcce}
    .chip-green{background:#2aff54;border-color:#138525}
    .chip-redline{width:20px;height:0;border-top:4px dashed #ff3644;border-radius:0}
    .chip-line{width:20px;height:0;border-top:5px solid #a259ff;border-radius:0}
    .small{color:#ddd;font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <div class="bg-gradient" aria-hidden="true"></div>
  <div class="wrap">
    <a class="back btn link" href="../../index.html">← Retour à l’index</a>
    <h1>Exercice 3 — Leaflet Plus</h1>
    <p class="muted">Dans ce TP, j’ai utilisé Leaflet pour aller plus loin : choix du fond de carte, affichage de la précision de ma géolocalisation, calcul de distance avec Marseille et intégration de données publiques (GeoJSON).</p>
    <div id="map" role="region" aria-label="Carte interactive Leaflet"></div>
    <div class="panel">
      <strong>Notes de test :</strong>
      <ul class="muted">
        <li>Pensez à autoriser la localisation (HTTPS ou <em>localhost</em>).</li>
        <li>Sur PC, on peut simuler la géolocalisation via Chrome DevTools (More tools → Sensors).</li>
        <li>Sur smartphone, le résultat est meilleur dehors avec le GPS activé.</li>
      </ul>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const nice=[43.7000,7.2667];
    const marseille=[43.2965,5.3698];

    const map=L.map('map',{center:nice,zoom:11});
    setTimeout(()=>map.invalidateSize(),150);

    const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'});
    const stamenWatercolor=L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.jpg',{maxZoom:16,attribution:'Map tiles by Stamen, Données &copy; OpenStreetMap'});
    const cartoLight=L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{subdomains:'abcd',maxZoom:20,attribution:'&copy; OpenStreetMap contributors &copy; CARTO'});
    cartoLight.addTo(map);

    L.control.layers({'CARTO Light':cartoLight,'OSM':osm,'Stamen Watercolor':stamenWatercolor},null,{position:'topleft'}).addTo(map);

    const markerNice=L.marker(nice,{icon:L.icon({iconUrl:"https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-blue.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowUrl:"https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-shadow.png",shadowSize:[41,41]})}).addTo(map).bindPopup('Nice — Centre ville');

    let meMarker=null;
    let meCircle=L.circle(nice,{radius:120,color:'#0abcce',weight:3,fillColor:'#21f7ef',fillOpacity:0.35}).addTo(map);
    let firstFix=true;

    L.polyline([marseille,nice],{color:'#ff3644',weight:4,dashArray:'7 8'}).addTo(map).bindPopup('Segment Marseille ↔ Nice');

    const distanceCtrl=L.control({position:'topright'});
    distanceCtrl.onAdd=function(){const div=L.DomUtil.create('div','info-box');div.id='distBox';div.innerHTML='Distance Marseille ↔ Moi : <strong>—</strong>';return div;};
    distanceCtrl.addTo(map);

    function setDistanceText(km){const box=document.getElementById('distBox');if(box)box.innerHTML='Distance Marseille ↔ Moi : <strong>'+km.toFixed(2)+' km</strong>';}

    const R=6371e3;
    function haversine([lat1,lon1],[lat2,lon2]){const toRad=d=>d*Math.PI/180;const f1=toRad(lat1),f2=toRad(lat2);const dF=toRad(lat2-lat1);const dL=toRad(lon2-lon1);const a=Math.sin(dF/2)**2+Math.cos(f1)*Math.cos(f2)*Math.sin(dL/2)**2;const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return R*c;}
    const dNiceMarseilleKm=haversine(nice,marseille)/1000;

    function onPos(pos){
      const {latitude,longitude,accuracy,speed}=pos.coords;
      const me=[latitude,longitude];
      if(firstFix){map.setView(me,Math.max(map.getZoom(),16));firstFix=false;}
      if(!meMarker){
        meMarker=L.marker(me,{icon:L.icon({iconUrl:"https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-blue.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowUrl:"https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-shadow.png",shadowSize:[41,41]})}).addTo(map).bindPopup('Ma position').openPopup();
      }else{
        meMarker.setLatLng(me);
      }
      const acc=Number(accuracy);
      const radius=(Number.isFinite(acc)&&acc>0)?acc:50;
      meCircle.setLatLng(me).setRadius(radius).bringToFront();
      meMarker.bringToFront();
      const dKm=haversine([latitude,longitude],marseille)/1000;
      setDistanceText(dKm);
      meMarker.setPopupContent(`Ma position<br>lat: ${latitude.toFixed(6)}, lon: ${longitude.toFixed(6)}<br>précision: ${Math.round(radius)} m<br>vitesse: ${speed==null?'n/a':(speed*3.6).toFixed(1)+' km/h'}<br>→ Marseille: ${dKm.toFixed(2)} km`);
    }
    function onErr(err){console.warn('Erreur géolocalisation:',err.code,err.message);}

    if('geolocation'in navigator){navigator.geolocation.watchPosition(onPos,onErr,{enableHighAccuracy:true,maximumAge:0,timeout:10000});}else{alert("La géolocalisation n’est pas supportée par ce navigateur.");}

    fetch('https://geo.api.gouv.fr/departements/06/communes?format=geojson&geometry=centre')
      .then(r=>r.json())
      .then(geojson=>{
        L.geoJSON(geojson,{pointToLayer:(feature,latlng)=>L.circleMarker(latlng,{radius:5,color:'#13c62b',weight:2,fillColor:'#2aff54',fillOpacity:1}),onEachFeature:(feature,layer)=>{const nom=feature.properties&&feature.properties.nom;layer.bindPopup(nom?`Commune: <strong>${nom}</strong>`:'Commune');}}).addTo(map);
      })
      .catch(e=>console.error('Erreur chargement GeoJSON:',e));

    const MAPBOX_TOKEN='pk.eyJ1IjoiY3YwNiIsImEiOiJjajg2MmpzYjcwbWdnMzNsc2NzM2l4eW0yIn0.TfDJipR5II7orUZaC848YA';
    (async()=>{
      try{
        const url=`https://api.mapbox.com/directions/v5/mapbox/driving/${marseille[1]},${marseille[0]};${nice[1]},${nice[0]}?geometries=geojson&access_token=${MAPBOX_TOKEN}`;
        const res=await fetch(url);
        const data=await res.json();
        const coords=data.routes[0].geometry.coordinates.map(([lon,lat])=>[lat,lon]);
        L.polyline(coords,{color:'#a259ff',weight:5}).addTo(map).bindPopup('Itinéraire routier (Mapbox)');
      }catch(err){console.error('Erreur Mapbox Directions:',err);}
    })();

    const legend=L.control({position:'bottomleft'});
    legend.onAdd=function(){const div=L.DomUtil.create('div','legend');div.innerHTML=`<h4>Légende</h4><div class="sym"><span class="chip chip-blue"></span> Marqueur : <strong>Nice</strong></div><div class="sym"><span class="chip chip-cyan"></span> Précision de ma position (accuracy)</div><div class="sym"><span class="chip chip-green"></span> Communes du 06</div><div class="sym"><span class="chip chip-redline"></span> Segment Marseille - Nice</div><div class="sym"><span class="chip chip-line"></span> Itinéraire routier avec Mapbox</div><div class="small">Distance Nice - Marseille : <strong>${dNiceMarseilleKm.toFixed(2)} km</strong> (formule Haversine)</div>`;return div;};
    legend.addTo(map);
  </script>
</body>
</html>
