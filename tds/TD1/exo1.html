<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TD1 – Exercice 1 : Géolocalisation</title>

  <!-- Reutilizamos tu CSS/JS globales -->
  <link rel="stylesheet" href="../../css/styles.css" />
  <script defer src="../../js/script.js"></script>

  <style>
    /* Un poco de estilo local para la tabla/estado */
    .wrap{width:min(980px,92vw);margin:40px auto}
    .back{display:inline-block;margin-bottom:14px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
    .panel h3{margin:6px 0 10px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px;align-items:center}
    .muted{color:var(--muted)}
    .ok{color:#22c55e;font-weight:600}
    .err{color:#ef4444;font-weight:600}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  </style>
</head>
<body>
  <div class="bg-gradient" aria-hidden="true"></div>
  <div class="wrap">
    <a class="back btn link" href="../../index.html">← Retour à l’index</a>
    <h1>Exercice 1 — Accès à la Géolocalisation</h1>
    <p class="muted">
      Objectif : afficher <strong>lon/lat/altitude</strong>, <strong>précision</strong>, <strong>vitesse</strong>
      et <strong>date</strong> (depuis le timestamp) en utilisant
      <code>getCurrentPosition</code> et <code>watchPosition</code>.
    </p>
    <div class="grid">
      <!-- Lecture unique -->
      <section class="panel">
        <h3>Mesure instantanée (<code>getCurrentPosition</code>)</h3>
        <div id="onceStatus" class="muted">En attente d’autorisation…</div>
        <dl class="kv mono" id="onceOut"></dl>
        <div class="controls">
          <button class="btn" id="btnOnce">Reprendre la mesure</button>
        </div>
      </section>
      <!-- Suivi continu -->
      <section class="panel">
        <h3>Suivi continu (<code>watchPosition</code>)</h3>
        <div id="watchStatus" class="muted">Inactif</div>
        <dl class="kv mono" id="watchOut"></dl>
        <div class="controls">
          <button class="btn primary" id="btnStart">Démarrer le suivi</button>
        </div>
      </section>
    </div>
    <details style="margin-top:14px">
      <summary>Notes utiles</summary>
      <ul>
        <li>La géolocalisation fonctionne en contexte sécurisé (HTTPS) ou <em>localhost</em>.</li>
        <li>La vitesse est renvoyée en m/s (nous affichons aussi km/h).</li>
        <li>L’altitude et sa précision peuvent être <em>null</em> selon l’appareil.</li>
      </ul>
    </details>
  </div>
<script>
const onceStatus = document.getElementById('onceStatus');
const onceOut = document.getElementById('onceOut');
const watchStatus = document.getElementById('watchStatus');
const watchOut = document.getElementById('watchOut');
const btnOnce = document.getElementById('btnOnce');
const btnStart = document.getElementById('btnStart');

let watchId = null;
let lastPosition = null;
let minDelta = 0.00005; // Lat/Lon, aprox equivale a ~5m, ajusta a precisión esperada

function fmt(n, d=6){ return (n==null || Number.isNaN(n)) ? 'n/a' : Number(n).toFixed(d); }
function fmtDate(ts){ return new Date(ts).toLocaleString(); }
function kmh(speed){
  if (speed == null) return 'n/a';
  if (speed < 0.5) return '0 (statique)';
  return (speed*3.6).toFixed(1) + ' km/h';
}
function rowsFromPosition(pos){
  const c = pos.coords;
  return `
    <dt>Latitude</dt><dd>${fmt(c.latitude)}</dd>
    <dt>Longitude</dt><dd>${fmt(c.longitude)}</dd>
    <dt>Altitude</dt><dd>${c.altitude ?? 'n/a'}</dd>
    <dt>Précision (m)</dt><dd>${c.accuracy ?? 'n/a'}</dd>
    <dt>Précision Alt (m)</dt><dd>${c.altitudeAccuracy ?? 'n/a'}</dd>
    <dt>Vitesse</dt><dd>${c.speed ?? 'n/a'} m/s (${kmh(c.speed)})</dd>
    <dt>Cap</dt><dd>${c.heading ?? 'n/a'}</dd>
    <dt>Date</dt><dd>${fmtDate(pos.timestamp)}</dd>
  `;
}
function explainError(err){
  const map = {
    1: "Permission refusée",
    2: "Position indisponible",
    3: "Délai dépassé"
  };
  return map[err.code] || (err.message || "Erreur inconnue");
}
function options(){
  return {
    enableHighAccuracy: true,
    timeout: 10000,
    maximumAge: 0
  };
}
// --- getCurrentPosition (une seule mesure)
function doOnce(){
  onceStatus.textContent = "Mesure en cours…";
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      onceStatus.innerHTML = '<span class="ok">OK</span>';
      onceOut.innerHTML = rowsFromPosition(pos);
    },
    (err)=>{
      onceStatus.innerHTML = '<span class="err">Erreur</span> ' + explainError(err);
      onceOut.innerHTML = '';
    },
    options()
  );
}
// --- watchPosition (suivi continu)
function positionChanged(newPos){
  if (!lastPosition) return true;
  const c = newPos.coords;
  const l = lastPosition.coords;
  // Solo actualiza si variaciones reales
  if (Math.abs(c.latitude - l.latitude) > minDelta) return true;
  if (Math.abs(c.longitude - l.longitude) > minDelta) return true;
  if (c.accuracy !== l.accuracy) return true;
  return false;
}
function startWatch(){
  if (watchId !== null) return;
  watchStatus.textContent = "Démarré…";
  btnStart.textContent = "Arrêter le suivi";
  btnStart.classList.remove("primary");
  btnStart.classList.add("err");
  watchId = navigator.geolocation.watchPosition(
    (pos)=>{
      if (positionChanged(pos)){
        watchStatus.innerHTML = '<span class="ok">OK</span>';
        watchOut.innerHTML = rowsFromPosition(pos);
        lastPosition = pos;
      }
    },
    (err)=>{
      watchStatus.innerHTML = '<span class="err">Erreur</span> ' + explainError(err);
    },
    options()
  );
}
function stopWatch(){
  if (watchId !== null){
    navigator.geolocation.clearWatch(watchId);
    watchId = null; lastPosition = null;
    watchStatus.textContent = "Inactif";
    btnStart.textContent = "Démarrer le suivi";
    btnStart.classList.add("primary");
    btnStart.classList.remove("err");
  }
}
// --- Wire UI
btnOnce.addEventListener('click', doOnce);
btnStart.addEventListener('click', ()=>{
  if(watchId === null){
    startWatch();
  }else{
    stopWatch();
  }
});
// --- Auto-demarrage
if ("geolocation" in navigator){
  doOnce();
  startWatch();
}else{
  onceStatus.textContent = watchStatus.textContent = "La géolocalisation n’est pas supportée par ce navigateur.";
}
</script>
</body>
</html>
